# Инструкция по установке версии 4.2.17

## Подготовка

### Требования

1. **Оборудование:**
   - ESP32 Dev Module или совместимая плата
   - USB кабель для подключения
   - OLED дисплей 128x64 (I2C)
   - Датчики температуры DS18B20
   - Реле для управления вентилятором и насосом

2. **Программное обеспечение:**
   - PlatformIO IDE или PlatformIO CLI
   - Python 3.x (для скриптов)
   - Git (опционально, для версионирования)

### Установка PlatformIO

#### Вариант 1: PlatformIO IDE (рекомендуется)

1. Скачайте и установите PlatformIO IDE с https://platformio.org/
2. Откройте PlatformIO IDE
3. Откройте папку проекта `stable_version_4.2.17`

#### Вариант 2: PlatformIO CLI

```bash
# Установка через pip
pip install platformio

# Или через установщик
# Windows: https://platformio.org/install/cli
```

## Шаг 1: Подготовка проекта

1. Скопируйте папку `stable_version_4.2.17` в удобное место
2. Откройте терминал в папке проекта
3. Проверьте структуру файлов:

```
stable_version_4.2.17/
├── src/
│   └── main.cpp
├── data/
│   └── index.html
├── platformio.ini
└── README.md
```

## Шаг 2: Настройка подключения

### Настройка COM-порта (для загрузки через USB)

1. Подключите ESP32 к компьютеру через USB
2. Определите COM-порт:
   - **Windows:** Диспетчер устройств → Порты (COM и LPT)
   - **Linux/Mac:** `ls /dev/tty*` или `dmesg | grep tty`

3. Отредактируйте `platformio.ini`:

```ini
upload_port = COM3  ; Замените на ваш COM-порт
```

### Настройка WiFi (опционально, для OTA)

WiFi настраивается при первом запуске через веб-интерфейс. Можно пропустить этот шаг.

## Шаг 3: Сборка проекта

### Сборка прошивки

```bash
# В PlatformIO IDE: нажмите кнопку "Build"
# Или через CLI:
pio run -e esp32dev_ota
```

### Сборка файловой системы (SPIFFS)

```bash
# В PlatformIO IDE: Tasks → esp32dev_ota → Build Filesystem Image
# Или через CLI:
pio run -e esp32dev_ota -t buildfs
```

## Шаг 4: Загрузка прошивки

### Вариант 1: Загрузка через USB (рекомендуется для первого раза)

1. Убедитесь, что ESP32 подключен к компьютеру
2. Загрузите прошивку:

```bash
# В PlatformIO IDE: нажмите кнопку "Upload"
# Или через CLI:
pio run -e esp32dev_ota -t upload
```

3. Загрузите файловую систему:

```bash
# В PlatformIO IDE: Tasks → esp32dev_ota → Upload Filesystem Image
# Или через CLI:
pio run -e esp32dev_ota -t uploadfs
```

### Вариант 2: Загрузка через OTA (если устройство уже работает)

1. Убедитесь, что устройство подключено к WiFi
2. Определите IP адрес устройства (через веб-интерфейс или роутер)
3. Используйте скрипт `upload_ota_final.py`:

```bash
python upload_ota_final.py <IP_адрес>
```

## Шаг 5: Первый запуск

### Подключение к устройству

1. После загрузки прошивки ESP32 перезагрузится
2. Если WiFi не настроен, устройство создаст точку доступа:
   - **SSID:** `ESP32-Kotel`
   - **Пароль:** `kotel12345`

3. Подключитесь к этой сети WiFi

4. Откройте браузер и перейдите на:
   - `192.168.4.1` (если подключены к точке доступа)
   - Или IP адрес устройства (если WiFi уже настроен)
   - Или `kotel.local` (если поддерживается mDNS)

### Настройка WiFi

1. В веб-интерфейсе выберите вашу WiFi сеть
2. Введите пароль
3. Нажмите "Подключиться"
4. Дождитесь подключения (может занять до 30 секунд)
5. Запишите IP адрес устройства

### Настройка системы

1. Перейдите в "Настройки" → "Система"
2. Настройте:
   - Уставку температуры (для режима Авто)
   - Гистерезис
   - Таймауты

3. Перейдите в "Настройки" → "MQTT"
4. Настройте:
   - Сервер MQTT
   - Порт
   - Логин и пароль (если требуется)
   - Префикс топиков

5. Перейдите в "Настройки" → "NTP"
6. Настройте:
   - Включить/выключить NTP
   - Сервер времени (по умолчанию: ru.pool.ntp.org)
   - Часовой пояс (по умолчанию: +3 для Москвы)

7. Перейдите в "Настройки" → "Датчики"
8. Привяжите датчики к параметрам:
   - Подача
   - Обратка
   - Котельная
   - Улица

## Шаг 6: Проверка работы

### Проверка веб-интерфейса

1. Откройте главную страницу
2. Убедитесь, что отображаются все температуры
3. Проверьте работу переключателя режимов

### Проверка OLED дисплея

1. Убедитесь, что дисплей подключен правильно
2. Проверьте отображение:
   - Температура подачи
   - Уставка
   - Время или статус подброса угля
   - WiFi статус

### Проверка MQTT

1. Подключитесь к MQTT брокеру (используйте MQTT клиент)
2. Подпишитесь на топик `{prefix}/state`
3. Убедитесь, что приходят сообщения с данными системы

### Проверка режима Комфорт

1. Убедитесь, что датчик температуры дома подключен и в сети
2. Проверьте LWT статус: `home/esp01/status` должен быть `online`
3. Переключитесь в режим Комфорт
4. Убедитесь, что режим не отключается автоматически

## Шаг 7: Обновление (опционально)

### Настройка автоматических обновлений

1. Перейдите в "Настройки" → "Обновления"
2. Включите "Автоматическая проверка обновлений"
3. Установите интервал проверки (рекомендуется: 24 часа)

### Ручное обновление

1. Перейдите в "Настройки" → "Обновления"
2. Нажмите "Проверить обновления"
3. Если доступна новая версия, нажмите "Установить обновление"
4. Дождитесь завершения (прогресс на OLED дисплее)
5. Устройство автоматически перезагрузится

## Устранение неполадок

### Устройство не загружается

1. Проверьте подключение USB кабеля
2. Проверьте COM-порт в `platformio.ini`
3. Попробуйте нажать кнопку RESET на ESP32 во время загрузки
4. Проверьте драйверы USB-to-Serial

### Веб-интерфейс не открывается

1. Проверьте подключение к WiFi
2. Проверьте IP адрес устройства
3. Попробуйте подключиться к точке доступа `ESP32-Kotel`
4. Проверьте Serial Monitor для сообщений об ошибках

### Температуры не отображаются

1. Проверьте подключение датчиков
2. Перейдите в "Настройки" → "Датчики"
3. Нажмите "Сканировать датчики"
4. Привяжите датчики к параметрам

### Режим Комфорт не работает

1. Проверьте LWT статус датчика: `home/esp01/status` должен быть `online`
2. Проверьте, что датчик публикует температуру в `home/esp01/temperature`
3. Проверьте Serial Monitor для сообщений об ошибках

### MQTT не подключается

1. Проверьте настройки MQTT в веб-интерфейсе
2. Проверьте доступность MQTT брокера
3. Проверьте логин и пароль
4. Проверьте Serial Monitor для сообщений об ошибках

## Дополнительная помощь

- См. `README.md` для общего описания
- См. `VERSION_INFO.md` для информации о версии
- См. `ПИНЫ_ПОДКЛЮЧЕНИЯ.md` для схемы подключения
- См. `MQTT_TOPICS.md` для описания MQTT топиков

---

**Версия:** 4.2.17  
**Дата:** 12.01.2026
