# Версия 3.0 - Котел ESP32

## Изменения в версии 3.0

### Новые возможности

1. **Стрелочки роста температуры**
   - Плавно мигающие стрелочки вверх (↑) рядом с каждой температурой
   - Показываются только при реальном росте температуры
   - Умный анализ тренда на основе истории последних значений
   - Защита от помех и выбросов

2. **Защита от помех датчиков**
   - Фильтрация резких скачков температуры (>5°C за один шаг)
   - Специальная защита для датчика обратки (часто отваливается)
   - Валидация диапазона температур (-50°C до 150°C)
   - Стабилизация значений перед принятием

3. **Улучшенная обработка энкодера**
   - Фильтрация дребезга на уровне ISR (500 мкс)
   - Полная обработка quadrature энкодера
   - Валидация переходов состояний
   - Защита от больших дельт (ограничение до ±4 шагов)
   - Улучшенная защита кнопки от ложных срабатываний

### Технические детали

#### Отслеживание тренда температуры

- История последних 10 значений для каждого датчика
- Анализ тренда на основе сравнения первой и второй половины последних 5 значений
- Порог определения роста: 0.1°C
- Стрелочки показываются только при росте (тренд = 1)

#### Защита от помех

- Максимальное изменение за шаг: 5°C (для обратки: 10°C)
- Проверка валидности диапазона
- Для датчика обратки: требуется 2 стабильных значения подряд

#### Структура данных

```cpp
struct TemperatureHistory {
  float values[10];  // История последних 10 значений
  int index;         // Текущий индекс
  int count;         // Количество записанных значений
  unsigned long lastUpdate;  // Время последнего обновления
  bool isValid;      // Валидность данных
};
```

### API изменения

Добавлены поля в `/api/status`:
- `supplyTrend` (опционально, только если = 1)
- `returnTrend` (опционально, только если = 1)
- `boilerTrend` (опционально, только если = 1)
- `outdoorTrend` (опционально, только если = 1)
- `homeTrend` (опционально, только если = 1)

### Веб-интерфейс

- Добавлены стрелочки рядом с каждой температурой
- Плавная анимация мигания (3 секунды цикл)
- Зеленый цвет стрелочек (#2ECC71)
- Стрелочки автоматически скрываются при отсутствии роста

### Константы

```cpp
const float TEMP_CHANGE_THRESHOLD = 0.1;  // Минимальное изменение для тренда
const float TEMP_NOISE_THRESHOLD = 5.0;   // Максимальное изменение за шаг
const unsigned long TEMP_UPDATE_INTERVAL = 2000;  // Интервал обновления (2 сек)
```

## Совместимость

- Полностью совместима с предыдущими версиями
- Все существующие API endpoints работают без изменений
- Новые поля в API опциональны и не ломают старые клиенты

## Установка

1. Скопировать файлы из `version_3.0/` в корень проекта
2. Загрузить прошивку: `pio run -e esp32dev_ota -t upload`
3. Загрузить веб-интерфейс: `pio run -e esp32dev_ota -t uploadfs`

## Откат

Для отката к предыдущей версии используйте файлы из папки `stable_version/` или `backup_v2.0/`.
