# Информация о версии 4.2.20

## Статус: ✅ Стабильная версия

## Дата выпуска: 12.01.2026

## Основные изменения

### Новые возможности

1. **Журнал перезагрузок**
   - Счетчик перезагрузок с сохранением в EEPROM
   - История перезагрузок (до 50 записей) с причинами
   - Отдельная вкладка "Журнал" в веб-интерфейсе
   - API endpoints: `/api/system/log` и `/api/system/bootlog/reset`
   - Перевод причин перезагрузки на русский язык

2. **Сохранение режима работы в EEPROM**
   - Режим работы (Авто/Комфорт) сохраняется при изменении
   - Автоматическое восстановление после перезагрузки
   - Автоматическое переключение из Комфорт в Авто при offline датчика при старте
   - Автоматическое переключение при изменении LWT статуса датчика

3. **Оптимизация веб-интерфейса**
   - Добавлены HTTP заголовки кэширования (`Cache-Control`, `Connection: keep-alive`)
   - Улучшена производительность загрузки страницы
   - Использование `streamFile` для эффективной передачи файлов

### Исправления

1. **Улучшена логика проверки датчика для режима Комфорт**
   - При старте проверяется LWT статус датчика
   - Если режим Комфорт, но датчик offline - автоматическое переключение в Авто
   - При изменении LWT статуса на "offline" - автоматическое переключение из Комфорт в Авто

2. **Исправлена работа с EEPROM**
   - Добавлены функции `saveWorkModeToEEPROM()` и `loadWorkModeFromEEPROM()`
   - Режим работы сохраняется при каждом изменении

## Технические детали

### Версия прошивки
- **Версия:** 4.2.20
- **Платформа:** ESP32
- **Framework:** Arduino
- **Размер Flash:** ~1.24 MB (94.9%)
- **Размер RAM:** ~55 KB (17.0%)

### Зависимости
- ArduinoOTA @ 2.0.0
- OneWire @ 2.3.8
- DallasTemperature @ 3.11.0
- ArduinoJson @ 6.21.5
- PubSubClient @ 2.8.0
- U8g2 @ 2.36.15
- NTPClient @ 3.2.1
- WiFiManager @ 2.0.17
- ESPmDNS @ 2.0.0

### Функциональность

#### Режимы работы
- ✅ Авто (управление по температуре подачи)
- ✅ Комфорт (управление по температуре дома)
- ✅ Сохранение режима в EEPROM
- ✅ Автоматическое восстановление после перезагрузки

#### Отслеживание датчиков
- ✅ LWT статус датчика температуры дома
- ✅ Автоматическое переключение из Комфорт в Авто при offline
- ✅ Блокировка переключения в Комфорт при offline
- ✅ Проверка при старте и при изменении LWT статуса

#### Веб-интерфейс
- ✅ Адаптивный дизайн (портретная/альбомная ориентация)
- ✅ Отображение всех температур
- ✅ Управление режимами
- ✅ Настройки системы
- ✅ OTA обновления
- ✅ Журнал перезагрузок
- ✅ Оптимизированная загрузка

#### MQTT
- ✅ Публикация данных
- ✅ Подписка на команды
- ✅ LWT для отслеживания статуса
- ✅ Публикация режима работы и уставки температуры дома

#### OLED дисплей
- ✅ Температура подачи и уставка
- ✅ Статус подброса угля или время
- ✅ WiFi статус

#### Система
- ✅ Журнал перезагрузок (до 50 записей)
- ✅ Счетчик перезагрузок
- ✅ Причины перезагрузок с переводом на русский
- ✅ Сохранение режима работы в EEPROM

## Известные ограничения

1. При обновлении через OTA веб-интерфейс недоступен во время загрузки
2. Прогресс обновления отображается только на OLED дисплее
3. При первом запуске может потребоваться несколько секунд для инициализации
4. Журнал перезагрузок ограничен 50 записями (циклический буфер)

## Рекомендации по использованию

1. **Перед обновлением:**
   - Сохраните текущие настройки через веб-интерфейс
   - Убедитесь, что устройство подключено к стабильному WiFi
   - Проверьте доступность MQTT брокера

2. **После обновления:**
   - Проверьте настройки MQTT
   - Проверьте подключение датчика температуры дома
   - Убедитесь, что режим Комфорт работает корректно
   - Проверьте журнал перезагрузок

3. **Мониторинг:**
   - Используйте веб-интерфейс для проверки статуса
   - Проверяйте Serial Monitor для диагностики
   - Используйте MQTT для интеграции с другими системами
   - Периодически проверяйте журнал перезагрузок

## Совместимость

- ✅ ESP32 Dev Module
- ✅ OLED дисплей 128x64 (I2C)
- ✅ Датчики DS18B20 (OneWire)
- ✅ MQTT брокер (любой совместимый)
- ✅ NTP сервер (ru.pool.ntp.org по умолчанию)

## Файлы версии

- `src/main.cpp` - основной код прошивки
- `data/index.html` - веб-интерфейс
- `platformio.ini` - конфигурация PlatformIO
- `upload_to_github.py` - скрипт загрузки на GitHub

## Следующие шаги

Эта версия стабильна и готова к использованию. Для дальнейшей разработки рекомендуется:

1. Создать новую ветку разработки
2. Не изменять файлы в этой папке
3. Использовать эту версию как эталон для отката

---

**Версия:** 4.2.20  
**Статус:** Стабильная  
**Дата:** 12.01.2026
