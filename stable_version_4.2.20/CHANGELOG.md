# История изменений версии 4.2.17

## Версия 4.2.17 (Стабильная) - 12.01.2026

### Исправления

1. **Исправлена логика проверки датчика для режима Комфорт**
   - **Проблема:** Режим комфорт включался, но сразу отключался, даже если датчик был в сети
   - **Причина:** Функция `isHomeTempSensorValid()` проверяла не только LWT статус, но и температуру (> 0) и таймаут (5 минут). Если датчик только что появился в сети, но еще не отправил температуру, режим комфорт отключался.
   - **Решение:** Если LWT статус = `online`, режим комфорт разрешен, даже если температура еще не получена или равна 0. Это позволяет включить режим комфорт сразу после появления датчика в сети.
   - **Файлы:** `src/main.cpp` (функция `isHomeTempSensorValid()`)

2. **Улучшено отображение offline статуса датчика**
   - При offline датчика текст "offline" отображается серым цветом (#888)
   - Скрыт значок "°C" при offline
   - Добавлен отдельный элемент `homeTempUnit` для управления отображением значка
   - **Файлы:** `data/index.html`

3. **Исправлено отображение температур в веб-интерфейсе**
   - Добавлены проверки существования элементов перед обновлением
   - Исправлена проблема, когда отображалась только температура подачи
   - Добавлена переменная `homeTempSensorLWTOnline` в функцию `updateData()`
   - **Файлы:** `data/index.html`

4. **Убрано модальное окно прогресса обновления**
   - **Причина:** Веб-сервер блокируется во время загрузки файла, прогресс не обновляется в реальном времени
   - **Решение:** Простое сообщение в статусе "Обновление началось. Устройство перезагрузится через несколько секунд... Прогресс можно отслеживать на OLED дисплее."
   - Удалены функции `showUpdateProgressModal()`, `closeUpdateProgressModal()`, `startUpdateProgressPolling()`, `stopUpdateProgressPolling()`, `updateUpdateProgress()`
   - **Файлы:** `data/index.html`

### Новые возможности

1. **Отображение времени на OLED дисплее**
   - Когда нет подброса угля, отображается текущее время с секундами в формате `HH:MM:SS`
   - Время берется из NTP, если он включен и синхронизирован
   - Отображается на той же позиции, где показывается статус подброса угля (строка 55)
   - **Файлы:** `src/main.cpp` (функция `updateDisplay()`)

### Технические детали

- **Версия прошивки:** 4.2.17
- **Размер Flash:** ~1.24 MB (94.9%)
- **Размер RAM:** ~55 KB (17.0%)
- **Платформа:** ESP32
- **Framework:** Arduino

### Зависимости

- ArduinoOTA @ 2.0.0
- OneWire @ 2.3.8
- DallasTemperature @ 3.11.0
- ArduinoJson @ 6.21.5
- PubSubClient @ 2.8.0
- U8g2 @ 2.36.15
- NTPClient @ 3.2.1
- WiFiManager @ 2.0.17
- ESPmDNS @ 2.0.0

## Предыдущие версии

### v4.2.16
- Добавлено модальное окно прогресса обновления (позже убрано)
- Исправлено отображение температур в веб-интерфейсе

### v4.2.15
- Добавлено отслеживание LWT статуса датчика температуры дома
- Автоматическое переключение из режима Комфорт в Авто при offline датчика
- Блокировка переключения в режим Комфорт при offline датчика

### v4.2.14
- Улучшено отображение прогресса обновления (скорость, размер файла)
- Исправлен CSS для книжной ориентации

### v4.2.13
- Добавлена проверка датчика дома перед переключением в режим комфорт
- Автоматическое переключение из комфорт в авто, если датчик offline
- Исправлен CSS для книжной ориентации

---

**Дата:** 12.01.2026  
**Статус:** ✅ Стабильная версия
