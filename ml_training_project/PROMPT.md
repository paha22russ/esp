# Промт для проекта обучения ML модели управления котлом

## Описание проекта

Разработать систему сбора данных и обучения модели машинного обучения для управления твердотопливным котлом. Система должна получать данные от ESP32 через MQTT, визуализировать их в реальном времени и подготавливать данные для обучения модели.

## Первый этап: Получение данных от MQTT и визуальное отображение

### Цель этапа
Создать десктопное приложение (Windows), которое:
1. Подключается к MQTT брокеру
2. Подписывается на топик с данными от котла
3. Получает JSON данные в реальном времени
4. Визуально отображает все параметры в удобном интерфейсе
5. Сохраняет полученные данные для последующего анализа

### Технические детали MQTT

**MQTT Брокер:**
- Адрес: `m5.wqtt.ru`
- Порт: `5374` (обычный) или `5375` (TLS)
- Пользователь: `u_OLTTB0`
- Пароль: `XDzCIXr0`

**Топик для подписки:**
- `kotel/device1/ml/data` - детальные данные для обучения модели (публикуются каждые 10 секунд по умолчанию)

**Префикс топика:** `kotel/device1` (может быть настроен в веб-интерфейсе ESP32)

### Структура JSON данных

Данные публикуются в формате JSON со следующей структурой:

```json
{
  // 1. Температуры
  "supplyTemp": 65.5,        // Температура подачи (°C)
  "returnTemp": 45.2,        // Температура обратки (°C)
  "boilerTemp": 70.0,        // Температура котла (°C)
  "outdoorTemp": -5.0,       // Температура на улице (°C)
  "tempDiff": 20.3,          // Разница температур подачи и обратки (°C)

  // 2. Состояния устройств
  "fan": true,               // Состояние вентилятора (true/false)
  "pump": true,              // Состояние насоса (true/false)
  "systemEnabled": true,     // Система включена/выключена (true/false)
  "state": "IDLE",           // Текущее состояние системы (строка)

  // 3. Настройки Auto режима
  "setpoint": 60.0,          // Уставка температуры (°C)
  "minTemp": 40.0,           // Минимальная температура (°C)
  "maxTemp": 80.0,           // Максимальная температура (°C)
  "hysteresis": 2.0,         // Гистерезис (°C)
  "inertiaTemp": 5.0,        // Температура инерции (°C)
  "inertiaTime": 300,        // Время инерции (секунды)
  "overheatTemp": 77.0,      // Температура перегрева (°C)
  "heatingTimeout": 1800,    // Таймаут нагрева (секунды)

  // 4. Подброс угля
  "coalFeedingActive": false,      // Активен ли подброс угля (true/false)
  "coalFeedingElapsed": 0,         // Время работы подброса (секунды)

  // 5. Временные метки
  "timestamp": 1704312000,   // Unix timestamp (секунды)
  "uptime": 86400,           // Время работы ESP32 (секунды)
  "time": "12:00:00",        // Время в формате HH:MM:SS (если NTP включен)
  "date": "03.01.2026",      // Дата в формате DD.MM.YYYY (если NTP включен)

  // 6. WiFi и сеть
  "wifiRSSI": -65,           // Уровень сигнала WiFi (dBm)
  "wifiSSID": "MyWiFi",      // Имя WiFi сети
  "wifiIP": "192.168.1.37",  // IP адрес ESP32

  // 7. Системные параметры
  "freeMem": 274548,         // Свободная память (байты)
  "heapSize": 327680,        // Размер heap (байты)

  // 8. ML настройки
  "mlPublishInterval": 10,   // Интервал публикации ML данных (секунды)

  // 9. Дополнительная информация
  "sensorCount": 4,          // Количество найденных датчиков DS18B20
  "mqttConnected": true       // Статус подключения MQTT (true/false)
}
```

### Требования к приложению

#### Функциональные требования:

1. **Подключение к MQTT:**
   - Настройка параметров подключения (адрес, порт, пользователь, пароль)
   - Автоматическое переподключение при разрыве связи
   - Индикация статуса подключения

2. **Визуальное отображение данных:**
   - **Панель температур:**
     - Температура подачи (большой индикатор, цветовая индикация)
     - Температура обратки
     - Температура котла
     - Температура на улице
     - Разница температур (подача - обратка)
     - Графики изменения температур в реальном времени

   - **Панель состояний:**
     - Статус вентилятора (вкл/выкл, визуальный индикатор)
     - Статус насоса (вкл/выкл, визуальный индикатор)
     - Статус системы (вкл/выкл)
     - Текущее состояние системы (IDLE, Работа, Перегрев и т.д.)
     - Статус подброса угля (если активен)

   - **Панель настроек:**
     - Уставка температуры
     - Минимальная/максимальная температура
     - Гистерезис
     - Параметры инерции
     - Температура перегрева

   - **Панель системной информации:**
     - Уровень сигнала WiFi (RSSI в dBm и процентах)
     - IP адрес ESP32
     - Время работы (uptime)
     - Свободная память
     - Текущее время и дата (если доступно)

   - **Панель статистики:**
     - Количество полученных сообщений
     - Время последнего сообщения
     - Средняя частота получения данных
     - Статус подключения MQTT

3. **Сохранение данных:**
   - Автоматическое сохранение всех полученных JSON сообщений
   - Формат сохранения: JSON Lines (каждое сообщение на новой строке)
   - Имя файла с датой и временем: `ml_data_YYYY-MM-DD_HH-MM-SS.jsonl`
   - Возможность выбора папки для сохранения
   - Индикация количества сохраненных записей

4. **Дополнительные функции:**
   - Фильтрация и поиск по данным
   - Экспорт данных в CSV для анализа
   - Настройка интервала обновления графиков
   - Темная/светлая тема интерфейса

#### Технические требования:

- **Платформа:** Windows 10/11
- **Язык программирования:** Python 3.10+ (рекомендуется) или C#/.NET
- **Библиотеки для MQTT:**
  - Python: `paho-mqtt` или `mqtt-client`
  - C#: `MQTTnet`
- **Библиотеки для GUI:**
  - Python: `tkinter`, `PyQt5/6`, `Kivy` или `CustomTkinter`
  - C#: WPF или WinForms
- **Библиотеки для графиков:**
  - Python: `matplotlib`, `plotly`, или `pyqtgraph`
  - C#: `OxyPlot` или `LiveCharts`

#### Интерфейс приложения:

1. **Главное окно:**
   - Меню настройки подключения MQTT
   - Вкладки или панели для разных категорий данных
   - Статусная строка с информацией о подключении

2. **Цветовая индикация:**
   - Температуры: синий (холодно) → зеленый (норма) → желтый (тепло) → красный (горячо)
   - Состояния устройств: зеленый (вкл), серый (выкл)
   - Статус подключения: зеленый (подключен), красный (отключен), желтый (подключение)

3. **Графики:**
   - График температур (4 линии: подача, обратка, котел, улица)
   - График разницы температур
   - График состояний устройств (вентилятор, насос)
   - Обновление в реальном времени (скользящее окно последних N точек)

### Пример структуры проекта

```
ml_training_project/
├── src/
│   ├── mqtt_client.py          # Класс для работы с MQTT
│   ├── data_processor.py       # Обработка и парсинг JSON данных
│   ├── gui_main.py             # Главное окно приложения
│   ├── widgets/                # Виджеты для отображения данных
│   │   ├── temperature_panel.py
│   │   ├── status_panel.py
│   │   ├── graph_panel.py
│   │   └── stats_panel.py
│   └── data_saver.py           # Сохранение данных в файл
├── data/                       # Сохраненные данные
├── docs/                       # Документация
├── requirements.txt            # Зависимости Python
└── README.md                   # Описание проекта
```

### Критерии успешного завершения первого этапа

1. ✅ Приложение успешно подключается к MQTT брокеру
2. ✅ Приложение получает данные из топика `kotel/device1/ml/data`
3. ✅ Все параметры отображаются в интерфейсе
4. ✅ Графики обновляются в реальном времени
5. ✅ Данные автоматически сохраняются в файл
6. ✅ Приложение стабильно работает при длительном подключении
7. ✅ Приложение корректно обрабатывает разрывы связи и переподключается

### Следующие этапы (после первого)

- Этап 2: Анализ данных и предобработка
- Этап 3: Разработка и обучение ML модели
- Этап 4: Валидация и тестирование модели
- Этап 5: Интеграция модели в систему управления

### Примечания

- Данные публикуются с интервалом, настроенным в ESP32 (по умолчанию 10 секунд)
- Размер JSON сообщения: ~540 байт
- Приложение должно быть готово к обработке больших объемов данных (тысячи сообщений)
- Рекомендуется использовать асинхронное программирование для обработки MQTT сообщений

