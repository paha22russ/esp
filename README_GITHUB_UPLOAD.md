# Скрипты для автоматической загрузки прошивки на GitHub

Этот набор скриптов автоматизирует процесс обновления прошивки на GitHub:
1. Обновляет версию в коде
2. Компилирует прошивку
3. Копирует `firmware.bin` в репозиторий GitHub
4. Обновляет `version.txt`
5. Делает commit и push изменений

## Файлы

- `upload_to_github.py` - Python скрипт (кроссплатформенный)
- `upload_to_github.ps1` - PowerShell скрипт (для Windows)

## Использование

### Python скрипт

```bash
python upload_to_github.py
```

Скрипт:
- Автоматически определит текущую версию из `src/main.cpp`
- Запросит новую версию (или автоинкремент при нажатии Enter)
- Скомпилирует прошивку через PlatformIO
- Склонирует/обновит репозиторий `../esp` (или рядом с проектом)
- Скопирует `firmware.bin` и обновит `version.txt`
- Сделает commit и push на GitHub

### PowerShell скрипт (Windows)

```powershell
.\upload_to_github.ps1
```

Или с указанием версии:

```powershell
.\upload_to_github.ps1 -NewVersion "4.2.1"
```

Или с указанием пути к репозиторию:

```powershell
.\upload_to_github.ps1 -NewVersion "4.2.1" -RepoPath "C:\path\to\esp"
```

## Требования

1. **Git** должен быть установлен и настроен
2. **PlatformIO** должен быть доступен (скрипт найдет его автоматически)
3. **Репозиторий GitHub** должен быть доступен (права на push)
4. **Python 3** (для Python скрипта) или **PowerShell** (для PS скрипта)

## Настройка

По умолчанию скрипты работают с репозиторием:
- Owner: `paha22russ`
- Repo: `esp`
- URL: `https://github.com/paha22russ/esp.git`

Чтобы изменить репозиторий, отредактируйте переменные в начале скрипта:
- `GITHUB_REPO_OWNER`
- `GITHUB_REPO_NAME`

## Автоинкремент версии

Если при запросе новой версии нажать Enter, скрипт автоматически увеличит патч-версию:
- `4.2.0` → `4.2.1`
- `4.2.1` → `4.2.2`
- и т.д.

## Что делает скрипт

1. **Читает текущую версию** из `#define FIRMWARE_VERSION` в `src/main.cpp`
2. **Обновляет версию в коде** (если указана новая)
3. **Компилирует прошивку** через PlatformIO (`pio run -e esp32dev_ota`)
4. **Работает с репозиторием**:
   - Если репозиторий существует - обновляет (`git pull`)
   - Если нет - клонирует (`git clone`)
5. **Копирует файлы**:
   - `.pio/build/esp32dev_ota/firmware.bin` → `repo/firmware.bin`
   - Создает/обновляет `repo/version.txt`
6. **Коммитит и пушит**:
   - `git add firmware.bin version.txt`
   - `git commit -m "Update firmware to version X.X.X"`
   - `git push`

## Пример использования

```bash
# Python
$ python upload_to_github.py
[INFO] Текущая версия: 4.2.0
Введите новую версию (или нажмите Enter для автоинкремента): 
4.2.1
Продолжить с версией 4.2.1? (y/n): y
...
[SUCCESS] Прошивка версии 4.2.1 успешно загружена на GitHub!
```

```powershell
# PowerShell
PS> .\upload_to_github.ps1 -NewVersion "4.2.1"
[INFO] Текущая версия: 4.2.0
[INFO] Новая версия: 4.2.1
Продолжить с версией 4.2.1? (y/n): y
...
[SUCCESS] Прошивка версии 4.2.1 успешно загружена на GitHub!
```

## Примечания

- Скрипт автоматически найдет PlatformIO в стандартных местах установки
- Репозиторий ищется в `../esp` относительно текущей директории
- Если git push не удался, файлы все равно будут готовы в репозитории для ручной отправки
- Версия в коде обновляется автоматически, но это можно отключить

## Устранение проблем

### Ошибка "git не найден"
Убедитесь, что Git установлен и доступен в PATH.

### Ошибка "PlatformIO не найден"
Убедитесь, что PlatformIO установлен. Скрипт ищет его в:
- Windows: `%USERPROFILE%\.platformio\penv\Scripts\platformio.exe`
- Или в PATH как `platformio`

### Ошибка "Permission denied" при push
Убедитесь, что у вас есть права на push в репозиторий. Возможно, нужно настроить SSH ключи или использовать Personal Access Token.

### Репозиторий не найден
Скрипт ищет репозиторий в `../esp` относительно текущей директории. Если репозиторий в другом месте, укажите путь через параметр `-RepoPath` (PowerShell) или измените переменную `repo_path` в Python скрипте.
