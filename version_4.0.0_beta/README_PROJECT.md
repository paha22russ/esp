# Система управления твердотопливным котлом для ESP32

## Описание проекта

Полнофункциональная система автоматического управления твердотопливным котлом с веб-интерфейсом, OLED дисплеем, энкодером для управления и интеграцией с MQTT.

**Версия прошивки:** 1.0.3

## Основные возможности

- ✅ Автоматическое управление вентилятором и насосом
- ✅ 4 датчика температуры DS18B20 (Подача, Обратка, Котельная, Улица)
- ✅ OLED дисплей 128x64 для отображения информации
- ✅ Роторный энкодер с кнопкой для управления
- ✅ Веб-интерфейс для настройки и мониторинга
- ✅ MQTT интеграция для удаленного мониторинга
- ✅ NTP синхронизация времени
- ✅ WiFi Manager для настройки сети
- ✅ OTA обновления прошивки
- ✅ Сохранение настроек в EEPROM

## Структура проекта

```
kotel_esp32/
├── include/              # Заголовочные файлы
│   ├── config.h          # Конфигурация пинов и констант
│   ├── boilerControl.h   # Управление котлом
│   ├── temperatureSensor.h # Датчики температуры
│   ├── oledDisplay.h     # OLED дисплей
│   ├── encoderHandler.h  # Обработка энкодера
│   ├── eepromStorage.h   # Сохранение настроек
│   ├── mqttManager.h     # MQTT клиент
│   ├── ntpTime.h         # NTP синхронизация
│   ├── MyWiFiManager.h   # WiFi управление
│   ├── webServer.h       # Веб-сервер
│   └── ota.h             # OTA обновления
├── src/                  # Исходные файлы
│   ├── main.cpp          # Главный цикл программы
│   └── ...               # Реализации всех компонентов
├── platformio.ini        # Конфигурация PlatformIO
└── ПИНЫ_ПОДКЛЮЧЕНИЯ.md   # Схема подключения

```

## Подключение оборудования

См. файл **ПИНЫ_ПОДКЛЮЧЕНИЯ.md** для подробной схемы подключения.

### Краткая схема пинов ESP32:

- **GPIO 16** - Реле вентилятора
- **GPIO 17** - Реле насоса
- **GPIO 21** - I2C SDA (OLED дисплей)
- **GPIO 22** - I2C SCL (OLED дисплей)
- **GPIO 4** - OneWire шина 1 (Подача, Обратка)
- **GPIO 5** - OneWire шина 2 (Котельная, Улица)
- **GPIO 18** - Энкодер CLK
- **GPIO 19** - Энкодер DT
- **GPIO 23** - Энкодер SW (кнопка)

## Первый запуск

1. Подключите оборудование согласно схеме в `ПИНЫ_ПОДКЛЮЧЕНИЯ.md`
2. Откройте проект в PlatformIO
3. Скомпилируйте и загрузите прошивку на ESP32
4. При первом запуске ESP32 создаст точку доступа:
   - SSID: `KotelAP`
   - Пароль: `kotel12345`
5. Подключитесь к точке доступа и настройте WiFi
6. Откройте веб-интерфейс по IP адресу устройства

## Веб-интерфейс

Веб-интерфейс доступен по адресу `http://IP_АДРЕС_УСТРОЙСТВА`

Основные разделы:
- Главная страница - мониторинг температур и состояния
- Настройки режима АВТО - параметры управления
- Привязка датчиков - настройка датчиков температуры
- Настройки MQTT - конфигурация MQTT брокера
- Настройки WiFi - управление сетью
- Настройки NTP - синхронизация времени
- Системная информация - информация об устройстве
- Инженерное меню - принудительное управление реле

## Управление через энкодер

- **Короткое нажатие** - Подброс угля (выключение вентилятора на 10 минут)
- **Поворот** - Вход в режим установки уставки
- **Удержание 3 сек** - Вход в меню
- **Удержание 10 сек** - Включение/выключение системы

## MQTT

По умолчанию настроен брокер `m5.wqtt.ru` с префиксом `kotel/device1`.

Публикуемые топики:
- `{prefix}/temperature/*` - Температуры
- `{prefix}/state` - Полное состояние системы (JSON)
- `{prefix}/simple/*` - Простые значения
- `{prefix}/network/*` - Информация о сети
- `{prefix}/uptime/*` - Время работы

Подписки:
- `{prefix}/setpoint/set` - Установка уставки

## Параметры по умолчанию

- Уставка температуры: 60°C
- Минимальная температура: 45°C
- Максимальная температура: 75°C
- Гистерезис: 2°C
- Температура инерции: 55°C
- Время инерции: 10 минут
- Температура перегрева: 77°C
- Таймаут разогрева: 30 минут

## Компиляция

```bash
pio run -e esp32dev
```

## Загрузка прошивки

```bash
pio run -e esp32dev -t upload
```

## OTA обновление

Для обновления по воздуху используйте:
- URL: `http://IP_АДРЕС_УСТРОЙСТВА/update`
- Логин: `admin`
- Пароль: `kotel12345`

Или используйте окружение `esp32dev_ota` для автоматической загрузки.

## Лицензия

Проект создан для управления твердотопливным котлом.

