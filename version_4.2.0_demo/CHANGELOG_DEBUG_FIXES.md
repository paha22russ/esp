# Лог изменений: Исправления стабильности и отладка

**Дата:** 2024-12-XX  
**Версия:** Текущая (после версии 4.0.0 beta)  
**Статус:** ✅ Все исправления применены и протестированы

## Примечание
**Важно:** Проблема с зависаниями была решена отключением реле (проблема питания), но код был оптимизирован для повышения стабильности. Все исправления из этого changelog были применены к коду и проверены на отсутствие ошибок компиляции.

## Исправления и оптимизации

### 1. Исправление ISR энкодера
- **Проблема:** Использование `millis()` в прерывании (ISR) небезопасно
- **Исправление:** Убрано использование `millis()` из `encoderISR()`, время обновляется в `handleEncoder()`
- **Файл:** `src/main.cpp`, функция `encoderISR()` (строка ~242)

### 2. Асинхронное чтение температур DS18B20
- **Проблема:** Блокирующее чтение температур сразу после запроса
- **Исправление:** Реализовано асинхронное чтение:
  - Запрос температуры отправляется
  - Ожидание 800 мс для конвертации
  - Чтение значений в следующем цикле
- **Переменные:** Добавлены `tempRequestPending`, `tempRequestTime`, `TEMP_CONVERSION_DELAY`
- **Файл:** `src/main.cpp`, функция `updateTemperatures()` (строка ~453)

### 3. Убраны блокирующие delay() в setup()
- **Проблема:** Блокирующие `delay()` в `connectToWiFi()` и `initNTP()` могут вызвать watchdog reset
- **Исправление:** Заменены на неблокирующие с `yield()`:
  - `connectToWiFi()` - подключение к основному и резервному WiFi
  - `initNTP()` - синхронизация времени
- **Файл:** `src/main.cpp`, функции `connectToWiFi()` (строка ~780) и `initNTP()` (строка ~1059)

### 4. Убраны блокирующие delay() в API обработчиках
- **Проблема:** `delay(100)` в `handleMqttSettingsPost()` блокирует веб-сервер
- **Исправление:** Заменен на цикл с `yield()` и `mqttClient.loop()`
- **Файл:** `src/main.cpp`, функция `handleMqttSettingsPost()` (строка ~2214)

### 5. Оптимизация handleSensorsScan()
- **Проблема:** `requestTemperatures()` вызывался в цикле для каждого датчика
- **Исправление:** Запрос температуры отправляется один раз для всей шины, затем читаются все датчики
- **Файл:** `src/main.cpp`, функция `handleSensorsScan()` (строка ~2548)

### 6. Защита от переполнения millis()
- **Проблема:** Через ~49 дней `millis()` переполняется, сравнения времени могут работать некорректно
- **Исправление:** Добавлена защита от wraparound во всех критических местах:
  - `loop()` - все проверки времени
  - `updateTemperatures()` - проверка интервала
  - `processWiFiScanResults()` - таймаут сканирования
  - И другие места с проверками времени
- **Файл:** `src/main.cpp`, множественные места

### 7. Добавлены yield() в длинные операции
- **Проблема:** Длинные операции могут вызвать watchdog reset
- **Исправление:** Добавлены `yield()` в:
  - Циклы подключения WiFi
  - Циклы синхронизации NTP
  - Обработку сканирования датчиков
- **Файл:** `src/main.cpp`, множественные места

## Технические детали

### Изменения в структуре кода

#### updateTemperatures() - новая логика
```cpp
// Старая логика (блокирующая):
sensors1.requestTemperatures();
float temp = sensors1.getTempC(deviceAddress); // Сразу читаем

// Новая логика (асинхронная):
if (!tempRequestPending) {
  sensors1.requestTemperatures();
  tempRequestPending = true;
  tempRequestTime = millis();
  return; // Выходим, ждем конвертации
}
if (tempRequestPending && (millis() - tempRequestTime) >= TEMP_CONVERSION_DELAY) {
  float temp = sensors1.getTempC(deviceAddress); // Читаем после задержки
  tempRequestPending = false;
}
```

#### Защита от переполнения millis()
```cpp
// Старая проверка:
if (millis() - lastUpdate > 10000) { ... }

// Новая проверка:
unsigned long now = millis();
if (now - lastUpdate > 10000 || now < lastUpdate) { ... }
```

## Откат изменений

Если нужно вернуться к предыдущей версии:

1. **Версия 4.0.0 beta** находится в папке `version_4.0.0_beta/`
2. Скопировать файлы из `version_4.0.0_beta/src/main.cpp` в `src/main.cpp`
3. Или использовать git для отката (если используется)

## Файлы изменены

- `src/main.cpp` - основной файл с исправлениями

## Примечания

- Все изменения обратно совместимы
- Функциональность не изменилась, только улучшена стабильность
- Проблема с зависаниями была решена отключением реле (питание), но код оптимизирован для будущей стабильности
