# Версия 4.2.0 Demo

**Дата создания:** 2024-12-XX  
**Статус:** Стабильная версия

## Описание

Оптимизированная версия прошивки для ESP32 управления котлом с улучшенной производительностью и отображением загрузки CPU.

## Основные изменения

### Оптимизация кода
- Удалено ~200+ отладочных сообщений Serial.print/println
- Оптимизирован веб-сервер (убраны лишние проверки SPIFFS)
- Уменьшены задержки при старте (с 1000 мс до 500 мс)
- Оптимизирована обработка веб-запросов

### Новые функции
- **Отображение загрузки CPU на OLED дисплее**
  - Обновление раз в секунду
  - Показывается в свободной строке (когда подброс угля не активен)
  - Формат: "CPU: X.X%"

### Оптимизация веб-интерфейса
- Добавлены заголовки кеширования (Cache-Control: max-age=3600)
- Keep-alive соединения для быстрых последующих запросов
- Потоковая передача файлов из SPIFFS
- Приоритет обработке веб-запросов в loop()

### Удалено
- Сложное меню с OLED дисплея (возвращено простое отображение)
- Режим "тест вентилятора"
- Лишние отладочные сообщения

## Структура файлов

- `main.cpp` - основной файл прошивки
- `index.html` - веб-интерфейс
- `platformio.ini` - конфигурация PlatformIO

## Использование

1. Скопировать файлы в соответствующие папки проекта:
   - `main.cpp` → `src/main.cpp`
   - `index.html` → `data/index.html`
   - `platformio.ini` → `platformio.ini`

2. Скомпилировать и загрузить прошивку:
   ```bash
   pio run -e esp32dev_ota -t upload
   pio run -e esp32dev_ota -t uploadfs
   ```

## Технические детали

### Загрузка CPU
- Измеряется время выполнения каждого loop()
- Вычисляется средняя загрузка за период обновления (1 секунда)
- Защита от переполнения micros()
- Обновление раз в секунду

### Оптимизация веб-сервера
- Потоковая передача файлов (не загружает весь файл в память)
- Кеширование на стороне клиента (1 час)
- Keep-alive соединения
- Приоритет обработке веб-запросов

### Используемые библиотеки
- ArduinoOTA - OTA обновления
- OneWire, DallasTemperature - датчики DS18B20
- ArduinoJson - JSON обработка
- PubSubClient - MQTT
- U8g2lib - OLED дисплей
- NTPClient - синхронизация времени
- WiFiManager - управление WiFi

## Известные ограничения

- Веб-интерфейс может загружаться медленно при первом открытии (зависит от размера файла и скорости WiFi)
- Повторные открытия используют кеш браузера (мгновенная загрузка)

## Откат к предыдущей версии

Для отката к предыдущей версии:
1. Использовать файлы из папки `version_4.1.0` или другой нужной версии
2. Скопировать файлы в соответствующие папки проекта
3. Перекомпилировать и загрузить
