# Инструменты диагностики зависаний ESP32

## Методы обнаружения зависаний

### 1. Watchdog Timer (WDT)
- **Назначение**: Автоматический перезапуск при зависании
- **Реализация**: Использует встроенный watchdog ESP32
- **Таймаут**: 30 секунд (настраивается)

### 2. Heartbeat/Keepalive
- **Назначение**: Отслеживание работы основного цикла `loop()`
- **Реализация**: Счетчик обновляется каждую итерацию `loop()`
- **Мониторинг**: Через Serial и веб-интерфейс

### 3. Профилирование времени выполнения
- **Назначение**: Определение медленных функций
- **Реализация**: Измерение времени выполнения критических функций
- **Вывод**: В Serial с временными метками

### 4. Мониторинг памяти
- **Назначение**: Обнаружение утечек памяти и переполнения стека
- **Метрики**:
  - Свободная heap память
  - Минимальная свободная память
  - Размер стека

### 5. Serial Debug с временными метками
- **Назначение**: Отслеживание последовательности выполнения
- **Формат**: `[TIMESTAMP] [FUNCTION] Message`

### 6. API для диагностики
- **Endpoint**: `/api/diagnostics`
- **Данные**: Статус системы, память, время работы, счетчики

## Использование

### Включение диагностики в коде:

```cpp
// Включить watchdog
#define ENABLE_WATCHDOG true
#define WATCHDOG_TIMEOUT 30  // секунд

// Включить профилирование
#define ENABLE_PROFILING true

// Включить мониторинг памяти
#define ENABLE_MEMORY_MONITOR true
```

### Мониторинг через Serial:

```
[12345] [LOOP] Iteration #1000, Free heap: 250000 bytes
[12350] [TEMP] Reading sensors took 850ms
[12355] [WIFI] Connection check took 5ms
[12360] [WDT] Watchdog fed
```

### Веб-интерфейс:

Откройте `/api/diagnostics` для получения JSON с диагностической информацией.

## Типичные проблемы и решения

### 1. Зависание в loop()
- **Симптом**: Watchdog перезапускает ESP32 каждые 30 секунд
- **Решение**: Проверить блокирующие операции, добавить `yield()`

### 2. Переполнение стека
- **Симптом**: Свободная память резко уменьшается
- **Решение**: Уменьшить размер локальных массивов, использовать динамическое выделение

### 3. Медленные операции
- **Симптом**: Время выполнения функции > 1000ms
- **Решение**: Оптимизировать или сделать асинхронным

### 4. Утечка памяти
- **Симптом**: Свободная память постоянно уменьшается
- **Решение**: Проверить динамическое выделение памяти, освобождение ресурсов
