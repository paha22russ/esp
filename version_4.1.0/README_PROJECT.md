# Система управления твердотопливным котлом для ESP32

## Описание проекта

Полнофункциональная система автоматического управления твердотопливным котлом с веб-интерфейсом, OLED дисплеем, энкодером для управления и интеграцией с MQTT.

**Версия прошивки:** 1.0.3

## Основные возможности

- ✅ Автоматическое управление вентилятором и насосом
- ✅ 4 датчика температуры DS18B20 (Подача, Обратка, Котельная, Улица)
- ✅ OLED дисплей 128x64 для отображения информации
- ✅ Роторный энкодер с кнопкой для управления
- ✅ Веб-интерфейс для настройки и мониторинга
- ✅ MQTT интеграция для удаленного мониторинга
- ✅ NTP синхронизация времени
- ✅ WiFi Manager для настройки сети
- ✅ OTA обновления прошивки
- ✅ Сохранение настроек в EEPROM

## Структура проекта

```
kotel_esp32/
├── include/              # Заголовочные файлы
│   ├── config.h          # Конфигурация пинов и констант
│   ├── boilerControl.h   # Управление котлом
│   ├── temperatureSensor.h # Датчики температуры
│   ├── oledDisplay.h     # OLED дисплей
│   ├── encoderHandler.h  # Обработка энкодера
│   ├── eepromStorage.h   # Сохранение настроек
│   ├── mqttManager.h     # MQTT клиент
│   ├── ntpTime.h         # NTP синхронизация
│   ├── MyWiFiManager.h   # WiFi управление
│   ├── webServer.h       # Веб-сервер
│   └── ota.h             # OTA обновления
├── src/                  # Исходные файлы
│   ├── main.cpp          # Главный цикл программы
│   └── ...               # Реализации всех компонентов
├── platformio.ini        # Конфигурация PlatformIO
└── ПИНЫ_ПОДКЛЮЧЕНИЯ.md   # Схема подключения

```

## Подключение оборудования

См. файл **ПИНЫ_ПОДКЛЮЧЕНИЯ.md** для подробной схемы подключения.

### Краткая схема пинов ESP32:

- **GPIO 16** - Реле вентилятора
- **GPIO 17** - Реле насоса
- **GPIO 21** - I2C SDA (OLED дисплей)
- **GPIO 22** - I2C SCL (OLED дисплей)
- **GPIO 4** - OneWire шина 1 (Подача, Обратка)
- **GPIO 5** - OneWire шина 2 (Котельная, Улица)
- **GPIO 18** - Энкодер CLK
- **GPIO 19** - Энкодер DT
- **GPIO 23** - Энкодер SW (кнопка)

## Первый запуск

1. Подключите оборудование согласно схеме в `ПИНЫ_ПОДКЛЮЧЕНИЯ.md`
2. Откройте проект в PlatformIO
3. Скомпилируйте и загрузите прошивку на ESP32
4. При первом запуске ESP32 создаст точку доступа:
   - SSID: `KotelAP`
   - Пароль: `kotel12345`
5. Подключитесь к точке доступа и настройте WiFi
6. Откройте веб-интерфейс по IP адресу устройства (IP адрес будет показан в Serial Monitor)
7. IP адрес также отображается в веб-интерфейсе в статус-баре (можно скопировать кликом)

## Веб-интерфейс

Веб-интерфейс доступен по адресу:
- `http://IP_АДРЕС_УСТРОЙСТВА` (IP адрес отображается в статус-баре интерфейса)
- `http://kotel.local` (если mDNS работает на вашем устройстве)

**Примечание:** mDNS может не работать на Android и некоторых версиях Windows. В этом случае используйте IP адрес.

Основные разделы:
- **Главная страница** - мониторинг температур и состояния
  - Индикатор состояния логики с таймерами
  - Звуковое предупреждение о перегреве
  - Отображение IP адреса (клик для копирования)
  - Индикация OTA обновления в реальном времени
- **Настройки режима АВТО** - параметры управления
- **Привязка датчиков** - настройка датчиков температуры
- **Настройки MQTT** - конфигурация MQTT брокера
- **Настройки WiFi** - управление сети
- **Настройки NTP** - синхронизация времени
- **Системная информация** - информация об устройстве
- **Инженерное меню** - принудительное управление реле

## Управление через энкодер

- **Короткое нажатие** - Подброс угля (выключение вентилятора на 10 минут)
- **Поворот** - Вход в режим установки уставки
- **Удержание 3 сек** - Вход в меню
- **Удержание 10 сек** - Включение/выключение системы

## MQTT

По умолчанию настроен брокер `m5.wqtt.ru` с префиксом `kotel/device1`.

### Публикуемые топики

#### Простые значения (`{prefix}/simple/*`)
Публикуются с интервалом, указанным в настройках (по умолчанию каждые 10 секунд):
- `{prefix}/simple/temp` - Температура подачи (°C, одно десятичное число)
- `{prefix}/simple/returnTemp` - Температура обратки (°C, одно десятичное число)
- `{prefix}/simple/outdoorTemp` - Температура улицы (°C, одно десятичное число)
- `{prefix}/simple/boilerTemp` - Температура котельной (°C, одно десятичное число)
- `{prefix}/simple/enabled` - Состояние системы (`1` - включена, `0` - выключена)
- `{prefix}/simple/setpoint` - Уставка температуры (°C, одно десятичное число)
- `{prefix}/simple/ip` - IP адрес устройства (с retain флагом)

**Пример:** При префиксе `kotel/device1`:
- `kotel/device1/simple/temp` → `65.5`
- `kotel/device1/simple/returnTemp` → `45.2`
- `kotel/device1/simple/outdoorTemp` → `-5.0`
- `kotel/device1/simple/boilerTemp` → `70.0`
- `kotel/device1/simple/enabled` → `1`
- `kotel/device1/simple/setpoint` → `60.0`
- `kotel/device1/simple/ip` → `192.168.0.197`

#### Полное состояние системы (`{prefix}/state`)
Публикуется с интервалом, указанным в настройках (по умолчанию каждые 30 секунд). Содержит полный JSON со всеми данными:
- Температуры: `supplyTemp`, `returnTemp`, `boilerTemp`, `outdoorTemp`, `homeTemp`
- Состояния: `fan`, `pump`, `systemEnabled`, `state`
- Настройки: `setpoint`
- Сеть: `wifiStatus`, `wifiRSSI`, `wifiIP`, `mqttStatus`
- Таймеры: `heatingElapsed`, `heatingRemaining`, `fanTestElapsed`, `fanTestRemaining`, `manualControlElapsed`, `manualControlRemaining`
- Предупреждения: `lowReturnTemp`, `coalBurned`
- Тренды температур: `supplyTrend`, `returnTrend`, `boilerTrend`, `outdoorTrend`, `homeTrend`
- OTA статус: `otaUpdateActive`, `otaUpdateProgress`, `otaUpdateType`, `otaUpdateError`

**Пример JSON:**
```json
{
  "supplyTemp": 65.5,
  "returnTemp": 45.2,
  "boilerTemp": 70.0,
  "outdoorTemp": -5.0,
  "homeTemp": 22.0,
  "setpoint": 60.0,
  "fan": true,
  "pump": true,
  "systemEnabled": true,
  "state": "HEATING",
  "wifiStatus": "Подключен",
  "wifiRSSI": -45,
  "wifiSSID": "MyWiFi",
  "wifiIP": "192.168.0.197",
  "wifiMAC": "AA:BB:CC:DD:EE:FF",
  "mqttStatus": "Подключен",
  "ip": "192.168.0.197",
  "uptime": 86400,
  "freeMem": 250000,
  "heatingElapsed": 1200,
  "heatingRemaining": 600,
  "fanTestElapsed": 0,
  "fanTestRemaining": 0,
  "manualControlElapsed": 0,
  "manualControlRemaining": 0,
  "coalFeeding": false,
  "coalFeedingRemaining": 0,
  "lowReturnTemp": false,
  "coalBurned": false,
  "supplyTrend": 1,
  "returnTrend": 0,
  "boilerTrend": 1,
  "outdoorTrend": -1,
  "homeTrend": 0,
  "otaUpdateActive": false
}
```

**Примечание:** Не все поля могут присутствовать в каждом сообщении. Поля с трендами (`*Trend`) присутствуют только если есть рост (1) или падение (-1). Таймеры присутствуют только когда соответствующие состояния активны.

#### ML данные (`{prefix}/ml/data`)
Публикуются только если включена функция ML обучения. Содержат детальную информацию для обучения модели.

### Подписки (входящие команды)

- `{prefix}/setpoint/set` - Установка уставки температуры
  - Формат: число с плавающей точкой (например: `60.5`)
  - Диапазон: 40-80°C

**Пример:** Отправка `60.5` в топик `kotel/device1/setpoint/set` установит уставку на 60.5°C

### Настройка MQTT

Настройки MQTT можно изменить через веб-интерфейс в разделе "Настройки MQTT":
- Включение/выключение MQTT
- Адрес сервера и порт
- Аутентификация (логин и пароль)
- Префикс топиков
- Интервалы публикации

## Параметры по умолчанию

- Уставка температуры: 60°C
- Минимальная температура: 45°C
- Максимальная температура: 75°C
- Гистерезис: 2°C
- Температура инерции: 55°C
- Время инерции: 10 минут
- Температура перегрева: 82°C
- Таймаут разогрева: 30 минут

## Компиляция

```bash
pio run -e esp32dev
```

## Загрузка прошивки

```bash
pio run -e esp32dev -t upload
```

## OTA обновление

Для обновления по воздуху используйте:
- URL: `http://IP_АДРЕС_УСТРОЙСТВА/update` или `http://kotel.local/update` (если mDNS работает)
- Пароль: `kotel12345`

Или используйте окружение `esp32dev_ota` для автоматической загрузки.

**Примечание:** mDNS (доступ по имени `kotel.local`) может не работать на некоторых устройствах (Android, некоторые версии Windows). В этом случае используйте IP адрес, который отображается в веб-интерфейсе в статус-баре.

## Лицензия

Проект создан для управления твердотопливным котлом.

